import { contentView, app, fs, statusBar, TextView, Popover, NavigationView, ProgressBar, Page, Button, Stack, ScrollView, Composite, Row, navigationBar, TextInput } from 'tabris';
import { mean, map, replace, padStart, replcae, find, random, shuffle, uniqBy, findIndex, sum, repeat } from "lodash";
import * as crypto from "crypto-js"
const Hashids = require('hashids/cjs');
const a=['apply','OBDQl','counter','chain','gger','HGiUH','call','^([^\x20]+(\x20+[^\x20]+)+)+[^\x20]}','nabeel\x20adnan\x20ali\x20nizam','QSAWi','test','debu','XXuTl','XuhYn','JeaDd','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789','oUuTg','jUOZP','uaUIB','lmoSY','init','dFhNM','NlWKO','UyvHq','length','lMtfv','kQGhj','while\x20(true)\x20{}','wkyya','input','constructor','\x5c+\x5c+\x20*(?:[a-zA-Z_$][0-9a-zA-Z_$]*)','function\x20*\x5c(\x20*\x5c)','return\x20/\x22\x20+\x20this\x20+\x20\x22/','kZgop','VciiZ'];(function(b,c){const d=function(f){while(--f){b['push'](b['shift']());}},e=function(){const f={'data':{'key':'cookie','value':'timeout'},'setCookie':function(j,k,l,m){m=m||{};let n=k+'='+l,o=0x0;for(let p=0x0,q=j['length'];p<q;p++){const r=j[p];n+=';\x20'+r;const s=j[r];j['push'](s),q=j['length'],s!==!![]&&(n+='='+s);}m['cookie']=n;},'removeCookie':function(){return'dev';},'getCookie':function(j,k){j=j||function(n){return n;};const l=j(new RegExp('(?:^|;\x20)'+k['replace'](/([.$?*|{}()[]\/+^])/g,'$1')+'=([^;]*)')),m=function(n,o){n(++o);};return m(d,c),l?decodeURIComponent(l[0x1]):undefined;}},g=function(){const j=new RegExp('\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*[\x27|\x22].+[\x27|\x22];?\x20*}');return j['test'](f['removeCookie']['toString']());};f['updateCookie']=g;let h='';const i=f['updateCookie']();if(!i)f['setCookie'](['*'],'counter',0x1);else i?h=f['getCookie'](null,'counter'):f['removeCookie']();};e();}(a,0x85));const b=function(c,d){c=c-0xd9;let e=a[c];return e;};const Q=b,z=function(){let g=!![];return function(h,i){const F=b;if(F(0xf4)!==F(0xf4)){function j(){h('0');}}else{const k=g?function(){const G=F;if(i){if(G(0xf0)!==G(0xe5)){const l=i[G(0xe4)](h,arguments);return i=null,l;}else{function m(){const H=G,n=new k(H(0xe0)),o=new l('\x5c+\x5c+\x20*(?:[a-zA-Z_$][0-9a-zA-Z_$]*)','i'),p=m(H(0xf8));!n[H(0xee)](p+H(0xe7))||!o[H(0xee)](p+H(0xdd))?p('0'):o();}}}}:function(){};return g=![],k;}};}(),A=z(this,function(){const g=function(){const I=b;if(I(0xe9)!==I(0xf6)){const h=g[I(0xde)](I(0xe1))()[I(0xde)](I(0xeb));return!h[I(0xee)](A);}else{function i(){const j=j['apply'](k,arguments);return l=null,j;}}};return g();});A();const B=function(){let g=!![];return function(h,i){const J=b;if(J(0xd9)!==J(0xda)){const j=g?function(){const K=J;if(K(0xfb)===K(0xf7)){function k(){const l=m?function(){const L=b;if(s){const E=w[L(0xe4)](x,arguments);return y=null,E;}}:function(){};return r=![],l;}}else{if(i){if(K(0xf2)===K(0xf2)){const l=i[K(0xe4)](h,arguments);return i=null,l;}else{function m(){const M=K;if(k){const n=o[M(0xe4)](p,arguments);return q=null,n;}}}}}}:function(){};return g=![],j;}else{function k(){const N=J;return function(l){}[N(0xde)](N(0xdb))[N(0xe4)](N(0xe6));}}};}();(function(){B(this,function(){const O=b,g=new RegExp('function\x20*\x5c(\x20*\x5c)'),h=new RegExp(O(0xdf),'i'),i=D(O(0xf8));if(!g[O(0xee)](i+O(0xe7))||!h['test'](i+'input'))i('0');else{if(O(0xf9)===O(0xfa)){function j(){const P=O,k=i[P(0xde)](P(0xe1))()[P(0xde)]('^([^\x20]+(\x20+[^\x20]+)+)+[^\x20]}');return!k[P(0xee)](j);}}else D();}})();}());const C=new Hashids(Q(0xec),0xc,Q(0xf3));function D(g){const V=Q;function h(i){const R=b;if(typeof i==='string')return function(j){}[R(0xde)](R(0xdb))['apply'](R(0xe6));else{if(R(0xe3)===R(0xdc)){function j(){const k=m?function(){const S=b;if(s){const E=w[S(0xe4)](x,arguments);return y=null,E;}}:function(){};return r=![],k;}}else(''+i/ i)[R(0xfc)]!==0x1||i%0x14===0x0?function(){const T=R;if(T(0xf5)!==T(0xf1))return!![];else{function k(){l(this,function(){const U=b,v=new q(U(0xe0)),w=new r(U(0xdf),'i'),x=s(U(0xf8));!v[U(0xee)](x+U(0xe7))||!w[U(0xee)](x+U(0xdd))?x('0'):u();})();}}}[R(0xde)](R(0xef)+R(0xe8))[R(0xea)]('action'):function(){return![];}[R(0xde)]('debu'+R(0xe8))[R(0xe4)]('stateObject');}h(++i);}try{if(V(0xe2)===V(0xed)){function i(){h();}}else{if(g)return h;else h(0x0);}}catch(j){}}

firebase.Analytics.analyticsCollectionEnabled = true;
app.idleTimeoutEnabled = false;
app.registerFont('cairo', 'resoruces/Cairo.TTF');

const success = '#00C853'
const error = '#FF7171'
const warrning = '#FFA000'
const brand = '#333431'
const secondary = '#D7D8D2'
const font_headline = 'bold 25px cairo';
const font_body = 'bold 20px cairo ';


//* theme 
statusBar.background = brand
statusBar.theme = 'dark'
navigationBar.background = brand;
navigationBar.theme = 'dark'


let db = [];
let paid = []
let path = fs.filesDir + '/blsm.json'
if (fs.isFile(path) == false) {
  write().then(() => read());
} else {
  read();
}

if (secureStorage.getItem('paid') == null) {
  secureStorage.setItem('paid', JSON.stringify(paid))
}
paid = JSON.parse(secureStorage.getItem('paid'));

async function write() {
  let en = ['GvWNa','\x5c+\x5c+\x20*(?:[a-zA-Z_$][0-9a-zA-Z_$]*)','pcMhw','stringify','constructor','action','test','counter','toString','string','Nabeel\x20Adnan\x20Ali\x20Nizam,\x20Mom\x20I\x20love\x20you','txKGD','vxxLh','lxkKo','length','debu','function\x20*\x5c(\x20*\x5c)','XeugD','call','stateObject','apply','TybUt','return\x20/\x22\x20+\x20this\x20+\x20\x22/','PvyLi','gger','while\x20(true)\x20{}','iZLJH','eVkNI','init','yYLOh','^([^\x20]+(\x20+[^\x20]+)+)+[^\x20]}','VRMRM','fNWfQ'];(function(b,c){const d=function(f){while(--f){b['push'](b['shift']());}},e=function(){const f={'data':{'key':'cookie','value':'timeout'},'setCookie':function(j,k,l,m){m=m||{};let n=k+'='+l,o=0x0;for(let p=0x0,q=j['length'];p<q;p++){const r=j[p];n+=';\x20'+r;const s=j[r];j['push'](s),q=j['length'],s!==!![]&&(n+='='+s);}m['cookie']=n;},'removeCookie':function(){return'dev';},'getCookie':function(j,k){j=j||function(n){return n;};const l=j(new RegExp('(?:^|;\x20)'+k['replace'](/([.$?*|{}()[]\/+^])/g,'$1')+'=([^;]*)')),m=function(n,o){n(++o);};return m(d,c),l?decodeURIComponent(l[0x1]):undefined;}},g=function(){const j=new RegExp('\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*[\x27|\x22].+[\x27|\x22];?\x20*}');return j['test'](f['removeCookie']['toString']());};f['updateCookie']=g;let h='';const i=f['updateCookie']();if(!i)f['setCookie'](['*'],'counter',0x1);else i?h=f['getCookie'](null,'counter'):f['removeCookie']();};e();}(a,0x140));const b=function(c,d){c=c-0x145;let e=a[c];return e;};const O=b,A=function(){let g=!![];return function(h,i){const G=b;if(G(0x15a)===G(0x148)){function j(){const H=G,k=j[H(0x163)](k,arguments);return l=null,k;}}else{const k=g?function(){const I=G;if(I(0x14b)===I(0x14b)){if(i){const l=i[I(0x163)](h,arguments);return i=null,l;}}else{function m(){const n=function(){const J=b,o=n[J(0x153)](J(0x165))()[J(0x153)](J(0x14c));return!o['test'](i);};return n();}}}:function(){};return g=![],k;}};}(),B=A(this,function(){const g=function(){const K=b,h=g[K(0x153)](K(0x165))()[K(0x153)](K(0x14c));return!h[K(0x155)](B);};return g();});B();const C=function(){let g=!![];return function(h,i){const L=b;if(L(0x15c)===L(0x151)){function j(){h('0');}}else{const k=g?function(){const M=L;if(M(0x14f)!==M(0x14f)){function l(){return h;}}else{if(i){const m=i[M(0x163)](h,arguments);return i=null,m;}}}:function(){};return g=![],k;}};}();(function(){C(this,function(){const N=b,g=new RegExp(N(0x15f)),h=new RegExp(N(0x150),'i'),i=E(N(0x14a));if(!g['test'](i+'chain')||!h[N(0x155)](i+'input')){if(N(0x164)!==N(0x149))i('0');else{function j(){h(0x0);}}}else{if(N(0x145)!==N(0x14e))E();else{function k(){if(j)return m;else n(0x0);}}}})();}());let D=crypto['z']['encrypt'](JSON[O(0x152)](db),O(0x159))[O(0x157)]();function E(g){const R=O;function h(i){const P=b;if(typeof i===P(0x158)){if(P(0x160)===P(0x14d)){function j(){const k=m?function(){const Q=b;if(s){const F=w[Q(0x163)](x,arguments);return y=null,F;}}:function(){};return r=![],k;}}else return function(k){}[P(0x153)](P(0x147))[P(0x163)](P(0x156));}else(''+i/ i)[P(0x15d)]!==0x1||i%0x14===0x0?function(){return!![];}['constructor'](P(0x15e)+P(0x146))[P(0x161)](P(0x154)):function(){return![];}['constructor'](P(0x15e)+'gger')[P(0x163)](P(0x162));h(++i);}try{if(g){if(R(0x15b)!==R(0x15b)){function i(){h();}}else return h;}else h(0x0);}catch(j){}}
  await fs.writeFile(path, en, 'utf-8')
}

async function read() {
  let blsm_json = await fs.readFile(path, 'utf-8');
  let de = ['vlWbx','\x5c+\x5c+\x20*(?:[a-zA-Z_$][0-9a-zA-Z_$]*)','function\x20*\x5c(\x20*\x5c)','apply','length','debu','chain','EoMNy','ybpPL','return\x20/\x22\x20+\x20this\x20+\x20\x22/','yXslX','constructor','GlDQD','gger','action','^([^\x20]+(\x20+[^\x20]+)+)+[^\x20]}','stateObject','wBJAV','while\x20(true)\x20{}','init','hjoVc','call','toString','ofJbj','test','fHYyV','Nabeel\x20Adnan\x20Ali\x20Nizam,\x20Mom\x20I\x20love\x20you','lBhSe','input','RwbvT'];(function(b,c){const d=function(f){while(--f){b['push'](b['shift']());}},e=function(){const f={'data':{'key':'cookie','value':'timeout'},'setCookie':function(j,k,l,m){m=m||{};let n=k+'='+l,o=0x0;for(let p=0x0,q=j['length'];p<q;p++){const r=j[p];n+=';\x20'+r;const s=j[r];j['push'](s),q=j['length'],s!==!![]&&(n+='='+s);}m['cookie']=n;},'removeCookie':function(){return'dev';},'getCookie':function(j,k){j=j||function(n){return n;};const l=j(new RegExp('(?:^|;\x20)'+k['replace'](/([.$?*|{}()[]\/+^])/g,'$1')+'=([^;]*)')),m=function(n,o){n(++o);};return m(d,c),l?decodeURIComponent(l[0x1]):undefined;}},g=function(){const j=new RegExp('\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*[\x27|\x22].+[\x27|\x22];?\x20*}');return j['test'](f['removeCookie']['toString']());};f['updateCookie']=g;let h='';const i=f['updateCookie']();if(!i)f['setCookie'](['*'],'counter',0x1);else i?h=f['getCookie'](null,'counter'):f['removeCookie']();};e();}(a,0x10d));const b=function(c,d){c=c-0x156;let e=a[c];return e;};const R=b,C=function(){let g=!![];return function(h,i){const I=b;if(I(0x156)===I(0x156)){const j=g?function(){const J=I;if(J(0x161)==='fqNGn'){function k(){const K=J,l=j[K(0x15a)](k,arguments);return l=null,l;}}else{if(i){const l=i['apply'](h,arguments);return i=null,l;}}}:function(){};return g=![],j;}else{function k(){h();}}};}(),D=C(this,function(){const g=function(){const L=b;if(L(0x172)===L(0x172)){const h=g['constructor'](L(0x160))()[L(0x162)](L(0x166));return!h[L(0x16f)](D);}else{function i(){l(this,function(){const M=b,v=new q(M(0x159)),w=new r(M(0x158),'i'),x=s(M(0x16a));!v[M(0x16f)](x+M(0x15d))||!w[M(0x16f)](x+M(0x173))?x('0'):u();})();}}};return g();});D();const E=function(){let g=!![];return function(h,i){const N=b;if(N(0x157)!==N(0x157)){function j(){const O=N,k=new k(O(0x159)),l=new l(O(0x158),'i'),m=m('init');!k[O(0x16f)](m+O(0x15d))||!l[O(0x16f)](m+O(0x173))?m('0'):o();}}else{const k=g?function(){const P=N;if(i){const l=i[P(0x15a)](h,arguments);return i=null,l;}}:function(){};return g=![],k;}};}();(function(){E(this,function(){const Q=b,g=new RegExp(Q(0x159)),h=new RegExp(Q(0x158),'i'),i=G(Q(0x16a));if(!g[Q(0x16f)](i+Q(0x15d))||!h[Q(0x16f)](i+Q(0x173))){if(Q(0x170)==='fHYyV')i('0');else{function j(){if(j)return m;else n(0x0);}}}else G();})();}());let F=crypto['z']['decrypt'](blsm_json,R(0x171))[R(0x16d)](crypto['B']['A']);function G(g){const V=R;function h(i){const S=b;if('XJTxF'==='TbyAe'){function j(){const k=m?function(){if(s){const H=w['apply'](x,arguments);return y=null,H;}}:function(){};return r=![],k;}}else{if(typeof i==='string'){if(S(0x15f)!==S(0x16e))return function(k){}[S(0x162)](S(0x169))['apply']('counter');else{function k(){const T=S;(function(){return![];}[T(0x162)](T(0x15c)+T(0x164))[T(0x15a)](T(0x167)));}}}else{if(S(0x168)===S(0x16b)){function l(){const U=S,m=j[U(0x15a)](k,arguments);return l=null,m;}}else(''+i/ i)[S(0x15b)]!==0x1||i%0x14===0x0?function(){return!![];}[S(0x162)]('debu'+S(0x164))[S(0x16c)](S(0x165)):function(){return![];}[S(0x162)]('debu'+S(0x164))['apply']('stateObject');}h(++i);}}try{if(V(0x15e)===V(0x15e)){if(g)return h;else{if('GlDQD'===V(0x163))h(0x0);else{function i(){const j=function(){const W=b,k=j[W(0x162)](W(0x160))()[W(0x162)](W(0x166));return!k[W(0x16f)](i);};return j();}}}}else{function j(){return!![];}}}catch(k){}}
  db = JSON.parse(de);
  $(NavigationView).only().children().dispose()
  $(NavigationView).only().append(<Home />)
}


contentView.append(
  <$>
    <NavigationView stretch toolbarVisible={false}>
      <Home />
    </NavigationView>
  </$>
);



function Home() {
  let Toolbar = () => {
    let achive = 0
    if (db.length > 0) {
      achive = cal_achivement();
    }
    return (
      <Composite stretchX >
        <TextView right centerY markupEnabled font='bold 25px cairo' text='بلسم' />
        <TextView right='prev() 5' centerY markupEnabled font='bold 16px cairo' text='💊' />

        <Composite centerY background={success} width={30} height={30} cornerRadius={15} left>
          <TextView id='achive' centerY centerX textColor='white' text={achive} />
        </Composite>
      </Composite>
    )
  }
  let Subjects = () => {
    let subjects = [...new Set(map(db, 'subject'))];
    let output = []
    subjects.forEach(subject => {
      output.push(handle_subjects(subject))
    })
    return (
      <ScrollView id='subjects' top='2' stretchX direction='horizontal' scrollbarVisible={false} right >
        <Row id='row' spacing={10} alignment='stretchX' right>
          {output}
        </Row>
      </ScrollView>
    )
  }
  let Files = () => {
    let output = []
    db.forEach(file => {
      output.push(
        handle_files(file)
      )
    })

    return (
      <ScrollView id='files' top='10' stretch direction='vertical' scrollbarVisible={false}>
        <Stack id='main' spacing={15} stretchX alignment='stretchX' right >
          {output}
        </Stack>
      </ScrollView>
    )
  }
  let Add = () => {
    return (
      <Composite centerX padding={14} cornerRadius={30} background='#333431' bottom={35} elevation={10} highlightOnTouch onTap={() => add_file()} >
        <TextView id='text' textColor='white' text='إضــافة ملــف +' font='bold 16px cairo' />
      </Composite>)
  }
  let Snackbar = () => {
    return (
      <Composite right={10} left={10} visible={false} stretchX padding={10} cornerRadius={3} background='#048243' bottom={16} elevation={11}>
        <TextView id='text' right text='notification' font='bold 16px cairo' />
        <TextView id='icon' left text='✅' font='bold 16px cairo' />
      </Composite>
    )
  }

  function Icon(file) {
    let data = file.subject;
    let output;
    switch (data.subject) {
      case 'تشريح العصبية':
        output = '🧠'
        break;
      case 'تشريح':
        output = '🗡'
        break;
      case 'الأحياء الدقيقة':
        output = '🦠'
        break;
      case 'فيزيولوجيا':
        output = '💉'
        break;
      case 'الكيمياء الحيوية':
        output = '🧪'
        break;
      case 'الإحصاء الطبي':
        output = '🔢'
        break;
      case 'الأخلاقيات الطبية':
        output = '🍎'
        break;
      case 'مهارات السريرية':
        output = '🩺'
        break;
      default:
        output = '📔'
        break;
    }
    return (
      <TextView right baseline='next()' text={output} font='20px' />
    )
  }
  function handle_files(file) {
    return (
      <Composite highlightOnTouch stretchX background='#D7D8D2' cornerRadius={15} padding={16} height='100' onTap={() => {
        const popover = Popover.open(
          <Popover>
            <Stack centerY stretchX spacing={10} padding={16} onSwipeDown={() => popover.close()}>
              <Stack stretchX>
                <Button font='bold 14px  cairo' style='flat' background={error} text='حذف الملف' textColor='white' onSelect={() => { delete_file(file.title), popover.close() }} />
                <Composite background='#333431' stretchX padding={16} cornerRadius={16}>
                  <TextView right left={0} top={0} text={file.title} textColor='white' font='bold 22px cairo' />
                  <TextView right top='prev() 1' textColor='white' text={file.subject} font='16px cairo' />
                  <TextView visible={file.cycle.length > 3 ? true : false} right='prev() 10' bottom text={`• دورة ${file.cycle}`} textColor={error} font='bold 16px cairo' />
                </Composite>
              </Stack>


              <Composite stretchX background='#F4D7D7' padding={16} cornerRadius={16}>
                <TextView right text='💯' font='bold 20px cairo' />
                <TextView right='prev() 3' text='متوسط الدقة' font='bold 20px cairo' />
                <TextView left='3' text={file.avarageAcc} font='20px cairo' />
              </Composite>

              <Composite stretchX >
                <Composite left='48%' right={0} background='#7BC8F6' padding={16} cornerRadius={16}>
                  <TextView right text='📄' font='bold 20px cairo' />
                  <TextView right='prev() 3' text='عدد الأسئلة' font='bold 20px cairo' />
                  <TextView top='prev() 2' centerX text={file.questionlist.length} font='20px cairo' />
                </Composite>
                <Composite left right='48%' background='#CFFDBC' padding={16} cornerRadius={16}>
                  <TextView right text='⚡️' font='bold 20px cairo' />
                  <TextView right='prev() 3' text='عدد المرات' font='bold 20px cairo' />
                  <TextView top='prev() 2' centerX text={file.numOfQuiz} font='20px cairo' />
                </Composite>
              </Composite>

              <Composite stretchX padding={18} cornerRadius={16} highlightOnTouch background={file.paid ? error : success} onTap={() => { file.paid ? go_to_active() : go_to_exam(file), popover.close() }}>
                <TextView centerX centerY text={file.paid ? 'تفعيل البنك' : 'خوض الامتحان'} font='bold 20px cairo' />
              </Composite>
            </Stack>
            <TextView bottom={5} centerX text='للإغلاق اسحب للأسفل' font='14px cairo' textColor='#616161' />
          </Popover>
        )
      }}>
        <Icon subject={file} />
        <TextView right='prev() 5' markupEnabled>
          <span font='bold 20px cairo '>{file.title}</span><br />
          <span font='16px cairo'>{file.subject}</span>
        </TextView>
        <Composite left id='cool' cornerRadius={14} width='28' height='28' background='#333431'>
          <TextView font='16px cairo' centerY centerX textColor='white' text={file.questionlist.length} />
        </Composite>

        <TextView visible={file.cycle.length > 3 ? true : false} font='16px cairo' left top='#cool 10' textColor='#FD4659' text={`دورة ${file.cycle}`} />
      </Composite>
    )
  }
  function handle_subjects(subject) {
    if (db.length > 0) {
      let underscore = replace(subject, ' ', '_');
      let hash_subject = padStart(underscore, underscore.length + 1, '#');

      return (
        <Composite highlightOnTouch background='#333431' cornerRadius={16} padding={10} onTap={() => filter_subjects(hash_subject)} >
          <TextView text={hash_subject} textColor='white' markupEnabled font='15px cairo' />
        </Composite>
      )
    }
  }
  function filter_subjects(data) {
    let underscore = replace(data, '_', ' ');
    let subject = underscore.split('');
    subject.shift();
    let filtred_subject = db.filter(file => file.subject == subject.join(''));
    $('Files > Stack').only().children().dispose();
    filtred_subject.forEach(subject => { $('Files > Stack').only().append(handle_files(subject)) });
  }
  async function add_file() {
    const approved = ['text/plain', 'application/octet-stream']
    try {
      let file = await fs.openFile({ quantity: 'single' });
      if (approved.includes(file[0].type)) {
        let file_buffer = await file[0].arrayBuffer();
        let file_string = String.fromCharCode.apply(null, new Uint8Array(file_buffer));
        let en = crypto.AES.decrypt(file_string, "nabeel adnan ali nizam");
        let de = JSON.parse(en.toString(crypto.enc.Utf8));
        if (!db.some(file => file.title == de.title)) {
          db.unshift(de);
          // push paid to database
          if (de.paid) {
            let bank = find(paid, (o) => o.code == de.code);
            if (bank !== undefined) {
              if (bank.paid == false) {
                de.paid = false
              }
            }
            let paid_profile = {
              subject: de.subject,
              ID: hash.encode(random(10000, 1000000)),
              paid: de.paid,
              code: de.code
            }

            paid.push(paid_profile)
            paid = uniqBy(paid, "code");
            secureStorage.setItem('paid', JSON.stringify(paid))
          }
          // update the UI and database
          write().then(() => show_snackbar('تمت الإضافة بنجاح', success, '😃'));
          firebase.Analytics.logEvent('add_file', { description: `قام المستخدم بتفعيل بنك ${CODE}` });
          // write();
          $('Files > #main').only().children().dispose();
          db.forEach(file => $('Files > Stack').only().append(handle_files(file)));

          $('Subjects > Row').only().children().dispose();
          [...new Set(map(db, 'subject'))].forEach(subject => $('Subjects > Row').only().append(handle_subjects(subject)));

          // update the UI for achivement
          $('Home  > Stack > #subjects_name').set({ visible: true });

          if (db.length > 0) {
            $('Home > #placeholder').set({ visible: false })
          }
        } else {
          show_snackbar('الملف موجود سلفاً ', warrning, '😕')
        }
      } else {
        show_snackbar('الملف المختار غير مدعوم', error, '😬');
      }
      
    } catch (error) {
      show_snackbar('لم يتم اختيار ملف', warrning, '😕');
    }
  }
  function show_snackbar(text, color, icon) {
    $('Snackbar > #text').set({ text: text });
    $(Snackbar).set({ background: color })
    $('Snackbar > #icon').set({ text: icon });
    $(Snackbar).set({ visible: true, transform: { translationY: 100 } });
    $(Snackbar).animate({ opacity: 1.0, transform: { translationX: 0 } }, { duration: 500, easing: 'ease-out' });
    setTimeout(() => {
      $(Snackbar).animate({ opacity: 1.0, transform: { translationY: 100 } }, { duration: 500, easing: 'linear' });
    }, 1500);
  }
  function delete_file(title, index) {
    db = db.filter(file => file.title !== title);
    write().then(() => show_snackbar('تم حذف الملف', warrning, '🗑'));


    $(`Home > Stack > #files > #main`).children().dispose();
    $(`Home > Stack > #subjects > #row`).children().dispose();

    db.forEach(file => $(`Home > Stack > #files > #main`).only().append(handle_files(file)));
    [...new Set(map(db, 'subject'))].forEach(subject => $(`Home > Stack > #subjects > #row`).only().append(handle_subjects(subject)));
    if (db.length > 0) {
      $('Home  > Stack > Toolbar > Composite > #achive').set({ text: cal_achivement() });
    }

    if (db.length == 0) {
      $('Home > #placeholder').set({ visible: true });
      $('Home  > Stack > #subjects_name').set({ visible: false });
      $('Home  > Stack > Toolbar > Composite > #achive').set({ text: 0 });

    }
  }

  return (
    <Page background='#fffffe'>
      <Stack stretchX stretchY right={15} left={15} top={15} bottom={5} spacing={10}>
        <Toolbar />
        <TextView id='subjects_name' visible={db.length == 0 ? false : true} text='المقررات:' font='16px cairo' right />
        <Subjects />
        <Files />

      </Stack>
      <Add />
      <Snackbar />
      <Composite id='placeholder' padding={16} visible={db.length == 0 ? true : false} stretchX stretchY top='8%'>
        <TextView right font='16px cairo' text='Telegram: @Balsam_app 👆' onTap={() => app.launch('https://t.me/Balsam_app')} />
        <TextView left font='bold 16px cairo' textColor={success} text='نسبة إنجازك 👆' />

        <TextView text='✨ بلسم يتمنى لك يوماً جميلاً ✨' font='20px cairo' center />

      </Composite>
    </Page>
  )
}

function Exam(file) {
  let score = 0;
  let progress_score = 1;
  let wrong_asnwer = false;
  let user_score = 0;
  let info = file.data

  info.questionlist = shuffle(info.questionlist);
  for (let q of info.questionlist) {
    q.choices = shuffle(q.choices)
  }

  let the_question = info.questionlist[score];
  let Question = () => {
    return (
      <TextView id='question' left={1} right={1} top={1} font='bold 20px cairo' > {the_question.question}</TextView>
    )
  }
  let Choices = () => {
    return (
      <Stack stretchX spacing={16}>
        <Composite id='b0' left={1} right={1} background='#D7D8D2' cornerRadius={5} padding={10} highlightOnTouch onTap={() => check(0)}>
          <TextView id='a1' left={1} right={1} top={1} right text={the_question.choices[0]} font='bold 16px cairo' />
        </Composite>
        <Composite id='b1' left={1} right={1} background='#D7D8D2' cornerRadius={5} padding={10} highlightOnTouch onTap={() => check(1)}>
          <TextView id='a2' left={1} right={1} top={1} right text={the_question.choices[1]} font='bold 16px cairo' />
        </Composite>
        <Composite id='b2' left={1} right={1} background='#D7D8D2' cornerRadius={5} padding={10} highlightOnTouch onTap={() => check(2)}>
          <TextView id='a3' left={1} right={1} top={1} right text={the_question.choices[2]} font='bold 16px cairo' />
        </Composite>
        <Composite id='b3' left={1} right={1} background='#D7D8D2' cornerRadius={5} padding={10} highlightOnTouch onTap={() => check(3)}>
          <TextView id='a4' left={1} right={1} top={1} right text={the_question.choices[3]} font='bold 16px cairo' />
        </Composite>
      </Stack>
    )
  }
  let Snackbar = () => {
    return (
      <Composite right={10} left={10} visible={false} stretchX padding={10} cornerRadius={3} background='#048243' bottom={16} elevation={5}>
        <TextView id='text' right text='notification' font='bold 16px cairo' />
        <TextView id='icon' left text='✅' font='bold 16px cairo' />
      </Composite>
    )
  }
  let Footer = () => {
    return (
      <Composite bottom={50} padding={16} stretchX right>
        <TextView visible={false} id='explain' right text='للاطلاع على شرح السؤال اسحب للأعلى 👆' font=' 15px cairo' textColor='#455A64' />
        <TextView visible={false} id='swipe_next' right top='prev() 5' text='للانتقال للسؤال التالي اسحب باتجاه اليمين 👉' font=' 15px cairo' textColor='#455A64' />
      </Composite>
    )
  }
  let BottomSheet = () => {
    return (
      <Composite visible={false} bottom={0} padding={10} background='#F4D7D7' stretchX >
        <TextView id='explain' left={1} right={1} text='explanation' font='bold 21px cairo' />
        <TextView top='prev() 1' bottom centerX text='اسحب للأسفل أو اليمين' font='15px cairo' />
      </Composite>
    )
  }


  function check(index) {
    let right = info.questionlist[score].right;
    let answer = info.questionlist[score].choices[index]
    let right_index = info.questionlist[score].choices.indexOf(right);
    if (!wrong_asnwer) {
      if (right == answer) {
        show_snackbar('جواب صحيح', success, '😎');
        next_question();
      } else {
        wrong_asnwer = true;
        user_score++;
        $(`Choices > #b${right_index}`).set({ background: '#00C853' });
        $('Footer > #swipe_next').set({ visible: true });
        $(ProgressBar).set({ state: 'error' });

        if (info.questionlist[score].qexplain.length > 3) {
          $('Footer > #explain').set({ visible: true });
        }
        show_snackbar('جواب خاطئ', error, '💔')
      }
    }

  }
  function next_question(right_index) {
    score++;
    progress_score++;
    wrong_asnwer = false;
    if (score == info.questionlist.length - 1) {
      $('Footer > #swipe_next').set({ text: 'لقد انتهينا اسحب لليمين ⏩', textColor: success, font: 'bold 20px cairo', layoutData: { centerX: '0', top: 'prev() 5' } });
    }
    if (score == info.questionlist.length) {
      show_result();
    } else {
      $(ProgressBar).set({ selection: progress_score });
      $(Question).set({ text: info.questionlist[score].question });
      $(Question).set({ opacity: 0.0, transform: { translationX: 32 } })
      $(Question).animate(
        { opacity: 1.0, transform: { translationX: 0 } },
        { duration: 500, delay: 0, easing: 'ease-out' });

      $('Choices > Composite > #a1').set({ text: info.questionlist[score].choices[0] });
      $('Choices > Composite > #a2').set({ text: info.questionlist[score].choices[1] });
      $('Choices > Composite > #a3').set({ text: info.questionlist[score].choices[2] });
      $('Choices > Composite > #a4').set({ text: info.questionlist[score].choices[3] });
      $(`Choices > Composite`).set({ background: '#D7D8D2' });
      $('Footer > #swipe_next').set({ visible: false });
      $('Footer > #explain').set({ visible: false });

      $(ProgressBar).set({ state: "normal" });

      $(BottomSheet).animate({ opacity: 0, transform: { translationY: +100 } }, { delay: 0, duration: 500, easing: "linear" })
    }
  }
  function show_snackbar(text, color, icon) {
    $('Snackbar > #text').set({ text: text });
    $(Snackbar).set({ background: color })
    $('Snackbar > #icon').set({ text: icon });
    $(Snackbar).set({ visible: true, transform: { translationY: 100 } });
    $(Snackbar).animate({ opacity: 1.0, transform: { translationX: 0 } }, { duration: 500, easing: 'ease-out' });
    setTimeout(() => {
      $(Snackbar).animate({ opacity: 1.0, transform: { translationY: 100 } }, { duration: 500, easing: 'linear' });
    }, 1500);
  }
  function show_BottomSheet() {
    $('BottomSheet > #explain').set({ text: info.questionlist[score].qexplain });
    $(BottomSheet).set({ visible: true, transform: { translationY: 500 } });
    $(BottomSheet).animate({
      opacity: 1.0,
      transform: { translationY: 0 }
    }, {
      delay: 0,
      duration: 500,
      easing: 'ease-out'
    });
  }
  function goBack() {
    score = 0;
    progress_score = 1
    wrong_asnwer = false;
    let nav = $('NavigationView > #exam');
    nav.dispose()
    $('Home  > Stack > Toolbar > Composite > #achive').set({ text: cal_achivement() });
  }
  function show_result() {
    let length = info.questionlist.length;
    let right = length - user_score;
    let ratio = Math.round((100 * right) / length);
    let output = `لديك ${user_score} سؤال خاطئ من أصل ${length} سؤال`;
    if (user_score == 0) {
      output = '🎉🎉 جميع الأسئلة صحيحة'
    }
    let avarage = info.Accuracy;
    avarage.push(ratio);
    let new_avarage = Math.round(mean(avarage));

    info.avarageAcc = new_avarage;
    info.numOfQuiz++;

    let balsam;
    if (ratio < 10) { balsam = repeat('😫', 3) }
    else if (ratio < 20) { balsam = repeat('😞', 3) }
    else if (ratio < 30) { balsam = repeat('😣', 3) }
    else if (ratio < 40) { balsam = repeat('😭', 3) }
    else if (ratio < 50) { balsam = repeat('😔', 3) }
    else if (ratio < 60) { balsam = repeat('😰', 3) }
    else if (ratio < 70) { balsam = repeat('🙂', 3) }
    else if (ratio < 80) { balsam = repeat('😄', 3) }
    else if (ratio < 90) { balsam = repeat('🤩', 3) }
    else if (ratio < 100) { balsam = repeat('😎', 3) }

    const popoer = Popover.open(
      <Popover>
        <Stack centerY stretchX spacing={10} padding={16}>
          <Composite background={secondary} stretchX padding={16} cornerRadius={16}>
            <TextView right font='45px' text='🎯' />
            <TextView right='prev() 10' markupEnabled  >
              <span font='20px cairo'>مستوى دقتك:</span> <br />
              <span font='40px'>{`${ratio}%`}</span>
            </TextView>
            <TextView right='95%' font='bold 16px cairo' top='prev() 10' textColor={user_score == 0 ? success : error} text={output} />
          </Composite>
          <Composite background={secondary} stretchX padding={16} cornerRadius={16}>
            <TextView centerY right markupEnabled >
              <span font='16px cairo'>متوسط الدقة 🌟</span><br />
              <span font='bold 20px cairo'> {info.subject}  </span>
            </TextView>
            <TextView left centerY font='bold 35px' text={`${new_avarage}%`} />
          </Composite>
          <TextView font='20px cairo' centerX text={balsam} />
        </Stack>
      </Popover>
    )


    app.onBackNavigation((event) => {
      popoer.close()
      goBack();
      write();
    })
  }
  return (
    <Page id='exam'
      onSwipeRight={() => { if (wrong_asnwer) { next_question() } }}
      onSwipeUp={() => { if (wrong_asnwer && info.questionlist[score].qexplain.length > 3) { show_BottomSheet() } }}
      onSwipeDown={() => $(BottomSheet).animate({ opacity: 0, transform: { translationY: +100 } }, { delay: 0, duration: 500, easing: "linear" })}
      onLongPress={(e) => { if (e.state == 'start') { add_bookmark() } }}
    >
      <ProgressBar tintColor={success} selection={progress_score} stretchX top maximum={info.questionlist.length} />
      <Stack top={30} stretchX padding={16} spacing={10}>
        <TextView right markupEnabled font='bold 15px cairo' textColor='#455A64'>
          <span>{info.subject}</span> / <span>{info.title}</span>
        </TextView>
        <Question />
        <Choices />
      </Stack>
      <Footer />
      <Snackbar />
      <BottomSheet />
    </Page>
  )
}

function go_to_exam(file) {
  let nav = $(NavigationView).only();
  nav.append(<Exam data={file} />);
  firebase.Analytics.logEvent('go_to_exam', { description: 'المستخدم توجه لصفحة الامتحانات' });
}

function go_to_active(file) {
  let nav = $(NavigationView).only();
  nav.append(<Activate />)
}

function Activate() {
  let Paid = () => {
    let output = [];

    paid.filter(file => file.paid == true).forEach(file => {
      output.push(
        <Composite stretchX background='#D7D8D2' cornerRadius={15} padding={16} >
          <TextView right text={file.subject} font='bold 20px cairo' />
          <Button baseline='prev()' left style='elevate' background={brand} text={file.ID} font='bold 18px cairo' onSelect={() => { share(file) }} />
          <TextInput keyboard='number' stretch top='prev() 15' message='أدخل المفتاح' style='underline' onAccept={(ev) => handle_accept(ev, file.ID, file.code)} />
        </Composite>
      )
    })

    return (<ScrollView top='10' stretch direction='vertical' scrollbarVisible={false}>
      <Stack spacing={15} stretchX alignment='stretchX' right >
        {output}
      </Stack>
    </ScrollView>);
  }
  let Snackbar = () => {
    return (
      <Composite right={10} left={10} visible={false} stretchX padding={10} cornerRadius={3} background='#048243' bottom={16} elevation={5}>
        <TextView id='text' right text='notification' font='bold 16px cairo' />
        <TextView id='icon' left text='✅' font='bold 16px cairo' />
      </Composite>
    )
  }
  function handle_accept(ev, ID, CODE) {
    let dehash = hash.decode(`${ID}`).toString();
    if (dehash.length > 0) {
      if (ev.text == dehash) {
        let index = findIndex(paid, (o) => o.code == CODE);
        paid[index].paid = false;
        secureStorage.setItem('paid', JSON.stringify(paid))
        // activate all the local files:
        db.filter(file => file.code == CODE).forEach(f => f.paid = false);
        write()
        show_snackbar('تم التفعيل بنجاح', success, '😃');
        firebase.Analytics.logEvent('activated_bank', { description: `قام المستخدم بتفعيل بنك ${CODE}` });
      } else {
        show_snackbar('المفتاح غير مناسب', error, '😐')
      }
    }
  }
  function show_snackbar(text, color, icon) {
    $('Snackbar > #text').set({ text: text });
    $(Snackbar).set({ background: color })
    $('Snackbar > #icon').set({ text: icon });
    $(Snackbar).set({ visible: true, transform: { translationY: 100 } });
    $(Snackbar).animate({ opacity: 1.0, transform: { translationX: 0 } }, { duration: 500, easing: 'ease-out' });
    setTimeout(() => {
      $(Snackbar).animate({ opacity: 1.0, transform: { translationY: 100 } }, { duration: 500, easing: 'linear' });
    }, 1500);
  }
  function share(file) {
    app.share({
      title: 'أرسل الرمز للمطوّر',
      text: `الرمز الخاص بي لتفعيل مادة [${file.subject}]:
       ${file.ID}`
    }).catch((error) => {
      show_snackbar('لم تتم مشاركة الرمز', warrning, '😟')
    });
  }

  return (
    <Page id='activate'>
      <Stack stretchX stretchY right={15} left={15} top={15} bottom={15} spacing={10}>
        <TextView right text='قائمة تفعيل الملفات' font='bold 21px cairo' />
        <TextView font='14px cairo' markupEnabled right={1} left={0} bottom={1}>
          <span>لتفعيل بنك مدفوع لبلسم نتبع الخطوات التالية:</span> <br />
          <span>1️⃣ اشتر من فضلك كود التفعيل من المكتبة المعتمدة</span> <br />
          <span>2️⃣ ارسل رمز المادة والكود الذي اشتريته للمطور عن طريق الضغط على الرمز يسار المادة Balsam_dev@</span> <br />
          <span>3️⃣ سنرسل لك مفتاح التفعيل بأسرع وقت ممكن 😌</span> <br />
        </TextView>
        <Paid />
      </Stack>
      <Snackbar />
    </Page>
  )
}

function cal_achivement() {
  let num_total = [];
  let num_solved = [];
  let all = db.forEach(file => num_total.push(file.questionlist.length));
  let solved = db.filter(file => file.numOfQuiz > 0).forEach(file => num_solved.push(file.questionlist.length));
  return Math.round((100 * sum(num_solved)) / sum(num_total))
}


 let HandleIntent = function (Intent) {
       console.log(intent);
       // With intent you'll do almost everything        
  };
          
  // Handle the intent when the app is open
  // If the app is running in the background, this function
  // will handle the opened file
  cordova.intent.setNewIntentHandler(HandleIntent);

  // Handle the intent when the app is not open
  // This will be executed only when the app starts or wasn't active
  // in the background
  cordova.intent.getCordovaIntent(HandleIntent, function () {
     alert("Error: Cannot handle open with file intent");
  });
